package qm

// @note(judah): might be good to use chebyshev sin/cos instead if more precision is needed.

// Sin calculates the approximate sine of an angle specified in radians.
func Sin(x float32) float32 {
	i := floatToIntRounded(x * float32(halfMax) / Pi)
	if i < 0 {
		return sinCosLookup[(-((-i) & mask))+(maxCircleAngle-1)]
	} else {
		return sinCosLookup[i&mask]
	}
}

// Cos calculates the approximate cosine of an angle specified in radians.
func Cos(x float32) float32 {
	i := floatToIntRounded(x * float32(halfMax) / Pi)
	if i < 0 {
		return sinCosLookup[(-i+quarterMax)&mask]
	} else {
		return sinCosLookup[(i+quarterMax)&mask]
	}
}

// Acos calculates the approximate arc-cosine an angle specified in radians.
func Acos(a float32) float32 {
	n := float32(0)
	if a < 0 {
		n = 1
	}

	a = Abs(a)
	ac := float32(-0.0187293)
	ac = ac * a
	ac = ac + 0.0742610
	ac = ac * a
	ac = ac - 0.2121144
	ac = ac * a
	ac = ac + 1.5707288
	ac = ac * Sqrt(1.0-a)
	ac = ac - 2*n*ac

	return n*3.14159265358979 + ac
}

// Tan calculates the approximate tangent of an angle specified in radians.
func Tan(a float32) float32 {
	return Sin(a) / Cos(a)
}

// Atan calculates the approximate arc-tangent of an angle specified in radians (-pi/2 to pi/2).
func Atan(a float32) float32 {
	return Atan2(a, 1)
}

// Atan2 calculates the approximate arc-tangent of y/x.
func Atan2(y, x float32) float32 {
	t3 := Abs(x)
	t1 := Abs(y)
	t0 := max(t3, t1)
	t1 = min(t3, t1)
	t3 = 1 / t0
	t3 = t1 * t3

	t4 := t3 * t3
	t0 = -0.013480470
	t0 = t0*t4 + 0.057477314
	t0 = t0*t4 - 0.121239071
	t0 = t0*t4 + 0.195635925
	t0 = t0*t4 - 0.332994597
	t0 = t0*t4 + 0.999995630
	t3 = t0 * t3

	if Abs(y) > Abs(x) {
		t3 = 1.570796327 - t3
	}

	if x < 0 {
		t3 = 3.141592654 - t3
	}

	if y < 0 {
		t3 = -t3
	}

	return t3
}

// Square calculates the square of x.
func Square(x float32) float32 {
	return x * x
}

// Pow calculates the approximation of x raised to the power y.
func Pow(x, y float32) float32 {
	return Exp(x) * Log(y)
}

// Log calculates the approximate natural logarithm of x.
func Log(x float32) float32 {
	bx := ptrcastFloatToUint(x)
	ex := bx >> 23

	t := int32(ex) - 127
	bx = 1065353216 | (bx & 8388607)
	x = ptrcastUintToFloat(bx)
	return -1.49278 + (2.11263+(-0.729104+0.10969*x)*x)*x + 0.6931471806*float32(t)
}

// Exp calculates the approximate base-e exponential of x.
func Exp(x float32) float32 {
	const (
		a float32 = (1 << 23) / 0.69314718
		b float32 = (1 << 23) * (127 - 0.043677448)
		c float32 = 1 << 23
		d float32 = (1 << 23) * 255
	)

	x = a*x + b
	if x < c {
		x = 0
	} else if x > d {
		x = d
	}

	return ptrcastUintToFloat(uint32(x))
}

func floatToIntRounded(f float32) int32 {
	if f < 0 {
		return int32(fastFloor(f))
	} else {
		return int32(fastCeil(f + 1))
	}
}

func fastFloor(f float32) float32 {
	return float32(int64(f))
}

func fastCeil(f float32) float32 {
	return float32(int64(f + 1))
}

const (
	maxCircleAngle int32 = 512
	halfMax              = maxCircleAngle / 2
	quarterMax           = maxCircleAngle / 4
	mask                 = maxCircleAngle - 1
)

var sinCosLookup = [maxCircleAngle]float32{
	0.00000000000000000000,
	0.01227153837680816650,
	0.02454122900962829590,
	0.03680722415447235107,
	0.04906767606735229492,
	0.06132073700428009033,
	0.07356456667184829712,
	0.08579730987548828125,
	0.09801714122295379639,
	0.11022220551967620850,
	0.12241067737340927124,
	0.13458070158958435059,
	0.14673046767711639404,
	0.15885815024375915527,
	0.17096188664436340332,
	0.18303988873958587646,
	0.19509032368659973145,
	0.20711137354373931885,
	0.21910123527050018311,
	0.23105810582637786865,
	0.24298018217086791992,
	0.25486564636230468750,
	0.26671275496482849121,
	0.27851969003677368164,
	0.29028466343879699707,
	0.30200594663619995117,
	0.31368175148963928223,
	0.32531028985977172852,
	0.33688986301422119141,
	0.34841868281364440918,
	0.35989505052566528320,
	0.37131720781326293945,
	0.38268342614173889160,
	0.39399203658103942871,
	0.40524131059646606445,
	0.41642954945564270020,
	0.42755508422851562500,
	0.43861624598503112793,
	0.44961133599281311035,
	0.46053871512413024902,
	0.47139674425125122070,
	0.48218378424644470215,
	0.49289819598197937012,
	0.50353837013244628906,
	0.51410275697708129883,
	0.52458965778350830078,
	0.53499764204025268555,
	0.54532498121261596680,
	0.55557024478912353516,
	0.56573182344436645508,
	0.57580816745758056641,
	0.58579784631729125977,
	0.59569931030273437500,
	0.60551106929779052734,
	0.61523157358169555664,
	0.62485951185226440430,
	0.63439327478408813477,
	0.64383155107498168945,
	0.65317285060882568359,
	0.66241580247879028320,
	0.67155897617340087891,
	0.68060100078582763672,
	0.68954056501388549805,
	0.69837623834609985352,
	0.70710676908493041992,
	0.71573084592819213867,
	0.72424709796905517578,
	0.73265427350997924805,
	0.74095112085342407227,
	0.74913638830184936523,
	0.75720882415771484375,
	0.76516723632812500000,
	0.77301043272018432617,
	0.78073722124099731445,
	0.78834640979766845703,
	0.79583692550659179688,
	0.80320751667022705078,
	0.81045717000961303711,
	0.81758481264114379883,
	0.82458931207656860352,
	0.83146959543228149414,
	0.83822470903396606445,
	0.84485357999801635742,
	0.85135519504547119141,
	0.85772860050201416016,
	0.86397284269332885742,
	0.87008696794509887695,
	0.87607008218765258789,
	0.88192129135131835938,
	0.88763964176177978516,
	0.89322429895401000977,
	0.89867448806762695312,
	0.90398931503295898438,
	0.90916800498962402344,
	0.91420978307723999023,
	0.91911387443542480469,
	0.92387950420379638672,
	0.92850607633590698242,
	0.93299281597137451172,
	0.93733900785446166992,
	0.94154405593872070312,
	0.94560730457305908203,
	0.94952815771102905273,
	0.95330601930618286133,
	0.95694035291671752930,
	0.96043050289154052734,
	0.96377605199813842773,
	0.96697646379470825195,
	0.97003126144409179688,
	0.97293996810913085938,
	0.97570210695266723633,
	0.97831737995147705078,
	0.98078525066375732422,
	0.98310548067092895508,
	0.98527765274047851562,
	0.98730140924453735352,
	0.98917651176452636719,
	0.99090266227722167969,
	0.99247956275939941406,
	0.99390697479248046875,
	0.99518471956253051758,
	0.99631261825561523438,
	0.99729043245315551758,
	0.99811810255050659180,
	0.99879544973373413086,
	0.99932235479354858398,
	0.99969881772994995117,
	0.99992471933364868164,
	1.00000000000000000000,
	0.99992471933364868164,
	0.99969881772994995117,
	0.99932235479354858398,
	0.99879544973373413086,
	0.99811810255050659180,
	0.99729043245315551758,
	0.99631261825561523438,
	0.99518471956253051758,
	0.99390697479248046875,
	0.99247956275939941406,
	0.99090266227722167969,
	0.98917651176452636719,
	0.98730140924453735352,
	0.98527765274047851562,
	0.98310548067092895508,
	0.98078525066375732422,
	0.97831737995147705078,
	0.97570210695266723633,
	0.97293996810913085938,
	0.97003126144409179688,
	0.96697646379470825195,
	0.96377605199813842773,
	0.96043050289154052734,
	0.95694035291671752930,
	0.95330601930618286133,
	0.94952815771102905273,
	0.94560730457305908203,
	0.94154405593872070312,
	0.93733900785446166992,
	0.93299281597137451172,
	0.92850607633590698242,
	0.92387950420379638672,
	0.91911387443542480469,
	0.91420978307723999023,
	0.90916800498962402344,
	0.90398931503295898438,
	0.89867448806762695312,
	0.89322429895401000977,
	0.88763964176177978516,
	0.88192129135131835938,
	0.87607008218765258789,
	0.87008696794509887695,
	0.86397284269332885742,
	0.85772860050201416016,
	0.85135519504547119141,
	0.84485357999801635742,
	0.83822470903396606445,
	0.83146959543228149414,
	0.82458931207656860352,
	0.81758481264114379883,
	0.81045717000961303711,
	0.80320751667022705078,
	0.79583692550659179688,
	0.78834640979766845703,
	0.78073722124099731445,
	0.77301043272018432617,
	0.76516723632812500000,
	0.75720882415771484375,
	0.74913638830184936523,
	0.74095112085342407227,
	0.73265427350997924805,
	0.72424709796905517578,
	0.71573084592819213867,
	0.70710676908493041992,
	0.69837623834609985352,
	0.68954056501388549805,
	0.68060100078582763672,
	0.67155897617340087891,
	0.66241580247879028320,
	0.65317285060882568359,
	0.64383155107498168945,
	0.63439327478408813477,
	0.62485951185226440430,
	0.61523157358169555664,
	0.60551106929779052734,
	0.59569931030273437500,
	0.58579784631729125977,
	0.57580816745758056641,
	0.56573182344436645508,
	0.55557024478912353516,
	0.54532498121261596680,
	0.53499764204025268555,
	0.52458965778350830078,
	0.51410275697708129883,
	0.50353837013244628906,
	0.49289819598197937012,
	0.48218378424644470215,
	0.47139674425125122070,
	0.46053871512413024902,
	0.44961133599281311035,
	0.43861624598503112793,
	0.42755508422851562500,
	0.41642954945564270020,
	0.40524131059646606445,
	0.39399203658103942871,
	0.38268342614173889160,
	0.37131720781326293945,
	0.35989505052566528320,
	0.34841868281364440918,
	0.33688986301422119141,
	0.32531028985977172852,
	0.31368175148963928223,
	0.30200594663619995117,
	0.29028466343879699707,
	0.27851969003677368164,
	0.26671275496482849121,
	0.25486564636230468750,
	0.24298018217086791992,
	0.23105810582637786865,
	0.21910123527050018311,
	0.20711137354373931885,
	0.19509032368659973145,
	0.18303988873958587646,
	0.17096188664436340332,
	0.15885815024375915527,
	0.14673046767711639404,
	0.13458070158958435059,
	0.12241067737340927124,
	0.11022220551967620850,
	0.09801714122295379639,
	0.08579730987548828125,
	0.07356456667184829712,
	0.06132073700428009033,
	0.04906767606735229492,
	0.03680722415447235107,
	0.02454122900962829590,
	0.01227153837680816650,
	0.00000000000000012246,
	-0.01227153837680816650,
	-0.02454122900962829590,
	-0.03680722415447235107,
	-0.04906767606735229492,
	-0.06132073700428009033,
	-0.07356456667184829712,
	-0.08579730987548828125,
	-0.09801714122295379639,
	-0.11022220551967620850,
	-0.12241067737340927124,
	-0.13458070158958435059,
	-0.14673046767711639404,
	-0.15885815024375915527,
	-0.17096188664436340332,
	-0.18303988873958587646,
	-0.19509032368659973145,
	-0.20711137354373931885,
	-0.21910123527050018311,
	-0.23105810582637786865,
	-0.24298018217086791992,
	-0.25486564636230468750,
	-0.26671275496482849121,
	-0.27851969003677368164,
	-0.29028466343879699707,
	-0.30200594663619995117,
	-0.31368175148963928223,
	-0.32531028985977172852,
	-0.33688986301422119141,
	-0.34841868281364440918,
	-0.35989505052566528320,
	-0.37131720781326293945,
	-0.38268342614173889160,
	-0.39399203658103942871,
	-0.40524131059646606445,
	-0.41642954945564270020,
	-0.42755508422851562500,
	-0.43861624598503112793,
	-0.44961133599281311035,
	-0.46053871512413024902,
	-0.47139674425125122070,
	-0.48218378424644470215,
	-0.49289819598197937012,
	-0.50353837013244628906,
	-0.51410275697708129883,
	-0.52458965778350830078,
	-0.53499764204025268555,
	-0.54532498121261596680,
	-0.55557024478912353516,
	-0.56573182344436645508,
	-0.57580816745758056641,
	-0.58579784631729125977,
	-0.59569931030273437500,
	-0.60551106929779052734,
	-0.61523157358169555664,
	-0.62485951185226440430,
	-0.63439327478408813477,
	-0.64383155107498168945,
	-0.65317285060882568359,
	-0.66241580247879028320,
	-0.67155897617340087891,
	-0.68060100078582763672,
	-0.68954056501388549805,
	-0.69837623834609985352,
	-0.70710676908493041992,
	-0.71573084592819213867,
	-0.72424709796905517578,
	-0.73265427350997924805,
	-0.74095112085342407227,
	-0.74913638830184936523,
	-0.75720882415771484375,
	-0.76516723632812500000,
	-0.77301043272018432617,
	-0.78073722124099731445,
	-0.78834640979766845703,
	-0.79583692550659179688,
	-0.80320751667022705078,
	-0.81045717000961303711,
	-0.81758481264114379883,
	-0.82458931207656860352,
	-0.83146959543228149414,
	-0.83822470903396606445,
	-0.84485357999801635742,
	-0.85135519504547119141,
	-0.85772860050201416016,
	-0.86397284269332885742,
	-0.87008696794509887695,
	-0.87607008218765258789,
	-0.88192129135131835938,
	-0.88763964176177978516,
	-0.89322429895401000977,
	-0.89867448806762695312,
	-0.90398931503295898438,
	-0.90916800498962402344,
	-0.91420978307723999023,
	-0.91911387443542480469,
	-0.92387950420379638672,
	-0.92850607633590698242,
	-0.93299281597137451172,
	-0.93733900785446166992,
	-0.94154405593872070312,
	-0.94560730457305908203,
	-0.94952815771102905273,
	-0.95330601930618286133,
	-0.95694035291671752930,
	-0.96043050289154052734,
	-0.96377605199813842773,
	-0.96697646379470825195,
	-0.97003126144409179688,
	-0.97293996810913085938,
	-0.97570210695266723633,
	-0.97831737995147705078,
	-0.98078525066375732422,
	-0.98310548067092895508,
	-0.98527765274047851562,
	-0.98730140924453735352,
	-0.98917651176452636719,
	-0.99090266227722167969,
	-0.99247956275939941406,
	-0.99390697479248046875,
	-0.99518471956253051758,
	-0.99631261825561523438,
	-0.99729043245315551758,
	-0.99811810255050659180,
	-0.99879544973373413086,
	-0.99932235479354858398,
	-0.99969881772994995117,
	-0.99992471933364868164,
	-1.00000000000000000000,
	-0.99992471933364868164,
	-0.99969881772994995117,
	-0.99932235479354858398,
	-0.99879544973373413086,
	-0.99811810255050659180,
	-0.99729043245315551758,
	-0.99631261825561523438,
	-0.99518471956253051758,
	-0.99390697479248046875,
	-0.99247956275939941406,
	-0.99090266227722167969,
	-0.98917651176452636719,
	-0.98730140924453735352,
	-0.98527765274047851562,
	-0.98310548067092895508,
	-0.98078525066375732422,
	-0.97831737995147705078,
	-0.97570210695266723633,
	-0.97293996810913085938,
	-0.97003126144409179688,
	-0.96697646379470825195,
	-0.96377605199813842773,
	-0.96043050289154052734,
	-0.95694035291671752930,
	-0.95330601930618286133,
	-0.94952815771102905273,
	-0.94560730457305908203,
	-0.94154405593872070312,
	-0.93733900785446166992,
	-0.93299281597137451172,
	-0.92850607633590698242,
	-0.92387950420379638672,
	-0.91911387443542480469,
	-0.91420978307723999023,
	-0.90916800498962402344,
	-0.90398931503295898438,
	-0.89867448806762695312,
	-0.89322429895401000977,
	-0.88763964176177978516,
	-0.88192129135131835938,
	-0.87607008218765258789,
	-0.87008696794509887695,
	-0.86397284269332885742,
	-0.85772860050201416016,
	-0.85135519504547119141,
	-0.84485357999801635742,
	-0.83822470903396606445,
	-0.83146959543228149414,
	-0.82458931207656860352,
	-0.81758481264114379883,
	-0.81045717000961303711,
	-0.80320751667022705078,
	-0.79583692550659179688,
	-0.78834640979766845703,
	-0.78073722124099731445,
	-0.77301043272018432617,
	-0.76516723632812500000,
	-0.75720882415771484375,
	-0.74913638830184936523,
	-0.74095112085342407227,
	-0.73265427350997924805,
	-0.72424709796905517578,
	-0.71573084592819213867,
	-0.70710676908493041992,
	-0.69837623834609985352,
	-0.68954056501388549805,
	-0.68060100078582763672,
	-0.67155897617340087891,
	-0.66241580247879028320,
	-0.65317285060882568359,
	-0.64383155107498168945,
	-0.63439327478408813477,
	-0.62485951185226440430,
	-0.61523157358169555664,
	-0.60551106929779052734,
	-0.59569931030273437500,
	-0.58579784631729125977,
	-0.57580816745758056641,
	-0.56573182344436645508,
	-0.55557024478912353516,
	-0.54532498121261596680,
	-0.53499764204025268555,
	-0.52458965778350830078,
	-0.51410275697708129883,
	-0.50353837013244628906,
	-0.49289819598197937012,
	-0.48218378424644470215,
	-0.47139674425125122070,
	-0.46053871512413024902,
	-0.44961133599281311035,
	-0.43861624598503112793,
	-0.42755508422851562500,
	-0.41642954945564270020,
	-0.40524131059646606445,
	-0.39399203658103942871,
	-0.38268342614173889160,
	-0.37131720781326293945,
	-0.35989505052566528320,
	-0.34841868281364440918,
	-0.33688986301422119141,
	-0.32531028985977172852,
	-0.31368175148963928223,
	-0.30200594663619995117,
	-0.29028466343879699707,
	-0.27851969003677368164,
	-0.26671275496482849121,
	-0.25486564636230468750,
	-0.24298018217086791992,
	-0.23105810582637786865,
	-0.21910123527050018311,
	-0.20711137354373931885,
	-0.19509032368659973145,
	-0.18303988873958587646,
	-0.17096188664436340332,
	-0.15885815024375915527,
	-0.14673046767711639404,
	-0.13458070158958435059,
	-0.12241067737340927124,
	-0.11022220551967620850,
	-0.09801714122295379639,
	-0.08579730987548828125,
	-0.07356456667184829712,
	-0.06132073700428009033,
	-0.04906767606735229492,
	-0.03680722415447235107,
	-0.02454122900962829590,
	-0.01227153837680816650,
}
